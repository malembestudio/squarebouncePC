<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>SQUARE BOUNCE</title>
  <style>
    body { margin: 0; background: #000; overflow: hidden; }
    canvas { display: block; margin: auto; background: #111; }
  </style>
</head>
<body>
  <canvas id="juego" width="600" height="400"></canvas>
  <script>
    const canvas = document.getElementById("juego");
    const ctx = canvas.getContext("2d");

    // --- Estados ---
    let estado = "inicio"; // "inicio" | "jugando" | "gameover"

    // --- Constantes ---
    const ENEMIGO_TAM_INICIAL = 40;  // lado del enemigo
    const CRECIMIENTO_PX = 2;        // +2 px por rebote
    const REDUCCION_PX = 2;          // -2 px por moneda roja
    const JUGADOR_TAM = 40;
    const MONEDA_RADIO = 10;
    const RAYO_RADIO = 12;
    const FRESA_RADIO = 14;
    const VEL_BASE = 4;
    const BOOST_FACTOR = 2;
    const BOOST_MS = 8000;
    const FRESA_MS = 10000;          // fresa dura 10s

    // --- Jugador ---
    let x, y, color;
    let keys = {};
    let boostHasta = 0;

    // --- Enemigo ---
    let ex, ey, etam, evx, evy;

    // --- Monedas ---
    let mx, my;   // amarilla
    let mrx, mry; // roja (reduce enemigo -2)

    // --- Rayo ---
    let rayoActivo = false;
    let rx = 0, ry = 0;
    let siguienteRayo = 50; // por stage

    // --- Fresa ---
    let fresaActiva = false;
    let fx = 0, fy = 0;
    let siguienteFresa = 100; // por stage
    let fresaExpira = 0;

    // --- Puntos y Stage ---
    let puntosStage = 0; // se reinicia por stage
    let stage = 1;
    let mostrarStageCartel = false;
    let stageCartelHasta = 0;

    // --- Textos flotantes (+5p / +10p) ---
    let textos = []; // {msg, x, y, alpha}

    // ---------- AUDIO (Web Audio API) ----------
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let musicaActiva = false;
    let intervaloMusica = null;
    let audioDesbloqueado = false;

    function desbloquearAudio() {
      if (!audioDesbloqueado) {
        audioCtx.resume?.();
        audioDesbloqueado = true;
      }
    }
    function beep(freq, dur, type = "square", vol = 0.2) {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = type;
      osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
      gain.gain.setValueAtTime(vol, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.start(); osc.stop(audioCtx.currentTime + dur);
    }
    function sonidoRebote(){ beep(200,0.08,"square",0.15); }
    function sonidoMoneda(){ beep(650,0.12,"sine",0.22); }
    function sonidoMonedaRoja(){ beep(160,0.16,"sawtooth",0.25); }
    function sonidoRayo(){ beep(400,0.09,"square",0.3); setTimeout(()=>beep(800,0.09,"square",0.28),90); }
    function sonidoFresa(){ beep(700,0.09,"triangle",0.28); setTimeout(()=>beep(500,0.12,"triangle",0.24),100); }
    function sonidoGameOver(){
      beep(600,0.18,"triangle",0.3);
      setTimeout(()=>beep(400,0.18,"triangle",0.25),180);
      setTimeout(()=>beep(220,0.25,"triangle",0.22),360);
    }
    function reproducirMusica(){
      if (musicaActiva) return;
      musicaActiva = true;
      const notas=[440,523,392,659];
      let i=0;
      intervaloMusica=setInterval(()=>{ beep(notas[i%notas.length],0.2,"square",0.13); i++; },400);
    }
    function detenerMusica(){
      musicaActiva=false;
      if (intervaloMusica) clearInterval(intervaloMusica);
      intervaloMusica=null;
    }

    // ---------- Utilidades ----------
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
    function colisionAABB_centro(ax, ay, aw, ah, bx, by, bw, bh) {
      return (
        ax - aw/2 < bx + bw/2 &&
        ax + aw/2 > bx - bw/2 &&
        ay - ah/2 < by + bh/2 &&
        ay + ah/2 > by - bh/2
      );
    }
    function colisionCirculoCirculo(ax, ay, ar, bx, by, br) {
      const dx = ax - bx, dy = ay - by;
      return (dx*dx + dy*dy) <= (ar + br) * (ar + br);
    }
    function factorVelocidadPorStage(n){
      const capped=Math.min(n,5);
      return 1 + 0.333*(capped-1);
    }

    // ---------- Setup ----------
    function colocarMonedas() {
      mx  = Math.random() * (canvas.width  - 2*MONEDA_RADIO) + MONEDA_RADIO;
      my  = Math.random() * (canvas.height - 2*MONEDA_RADIO) + MONEDA_RADIO;
      mrx = Math.random() * (canvas.width  - 2*MONEDA_RADIO) + MONEDA_RADIO;
      mry = Math.random() * (canvas.height - 2*MONEDA_RADIO) + MONEDA_RADIO;
    }

    function iniciarStage(n){
      // Jugador: centro X, y a 40px de borde aleatorio
      x = canvas.width/2;
      y = Math.random() < 0.5 ? 40 : canvas.height - 40;
      color = "red";
      boostHasta = 0;

      // Enemigo: esquina aleatoria
      etam = ENEMIGO_TAM_INICIAL;
      const esquina = Math.floor(Math.random()*4);
      if (esquina===0){ ex=etam/2; ey=etam/2; evx=3; evy=2; }
      else if (esquina===1){ ex=canvas.width-etam/2; ey=etam/2; evx=-3; evy=2; }
      else if (esquina===2){ ex=etam/2; ey=canvas.height-etam/2; evx=3; evy=-2; }
      else { ex=canvas.width-etam/2; ey=canvas.height-etam/2; evx=-3; evy=-2; }
      const f=factorVelocidadPorStage(n);
      evx*=f; evy*=f;

      // Monedas
      colocarMonedas();

      // Powerups por stage
      rayoActivo=false;  siguienteRayo=50;
      fresaActiva=false; siguienteFresa=100; fresaExpira=0;

      // Puntos del stage
      puntosStage=0;

      // Cartel Stage
      mostrarStageCartel=true;
      stageCartelHasta=Date.now()+2000;

      // Limpia textos flotantes
      textos.length = 0;
    }

    function inicializarJuego(){
      stage=1;
      iniciarStage(stage);
      estado="jugando";
      desbloquearAudio();
      reproducirMusica();
    }

    // ---------- Entrada ----------
    document.addEventListener("keydown",(e)=>{
      keys[e.key]=true;
      if (estado==="inicio" && e.code==="Space"){ inicializarJuego(); }
      else if (estado==="gameover" && (e.key==="r"||e.key==="R")){ inicializarJuego(); }
    });
    document.addEventListener("keyup",(e)=> keys[e.key]=false);

    // ---------- LÃ³gica ----------
    function moverJugador(){
      const ahora=Date.now();
      const vel = VEL_BASE * (ahora < boostHasta ? BOOST_FACTOR : 1);
      if (keys["ArrowUp"])    { y-=vel; color="yellow"; }
      if (keys["ArrowDown"])  { y+=vel; color="blue";   }
      if (keys["ArrowLeft"])  { x-=vel; color="green";  }
      if (keys["ArrowRight"]) { x+=vel; color="purple"; }
      x = clamp(x, JUGADOR_TAM/2, canvas.width - JUGADOR_TAM/2);
      y = clamp(y, JUGADOR_TAM/2, canvas.height - JUGADOR_TAM/2);
    }

    function moverEnemigo(){
      ex+=evx; ey+=evy;
      let rebotedX=false, rebotedY=false;

      // Borde X
      if (ex - etam/2 < 0){ ex=etam/2; evx*=-1; rebotedX=true; }
      else if (ex + etam/2 > canvas.width){ ex=canvas.width - etam/2; evx*=-1; rebotedX=true; }

      // Borde Y
      if (ey - etam/2 < 0){ ey=etam/2; evy*=-1; rebotedY=true; }
      else if (ey + etam/2 > canvas.height){ ey=canvas.height - etam/2; evy*=-1; rebotedY=true; }

      if (rebotedX){ puntosStage++; sonidoRebote(); }
      if (rebotedY){ puntosStage++; sonidoRebote(); }
      if (rebotedX || rebotedY){
        etam += CRECIMIENTO_PX;
        ex = clamp(ex, etam/2, canvas.width - etam/2);
        ey = clamp(ey, etam/2, canvas.height - etam/2);
      }

      // Rayo cada 50 pts del stage
      if (puntosStage >= siguienteRayo && !rayoActivo){
        rx = Math.random()*(canvas.width - 2*RAYO_RADIO) + RAYO_RADIO;
        ry = Math.random()*(canvas.height - 2*RAYO_RADIO) + RAYO_RADIO;
        rayoActivo = true;
        siguienteRayo += 50;
      }

      // Fresa cada 100 pts del stage
      if (puntosStage >= siguienteFresa && !fresaActiva){
        fx = Math.random()*(canvas.width - 2*FRESA_RADIO) + FRESA_RADIO;
        fy = Math.random()*(canvas.height - 2*FRESA_RADIO) + FRESA_RADIO;
        fresaActiva = true;
        fresaExpira = Date.now() + FRESA_MS;
        siguienteFresa += 100;
      }
    }

    function actualizar(){
      if (estado!=="jugando") return;

      moverJugador();
      moverEnemigo();

      // Choque con enemigo
      if (colisionAABB_centro(x,y,JUGADOR_TAM,JUGADOR_TAM, ex,ey,etam,etam)){
        estado="gameover";
        detenerMusica();
        sonidoGameOver();
        return;
      }

      // Moneda amarilla: +5 pts stage + texto flotante
      if (colisionCirculoCirculo(x,y,JUGADOR_TAM/2, mx,my,MONEDA_RADIO)){
        puntosStage += 5;
        textos.push({ msg:"+5p", x:x, y:y - JUGADOR_TAM/2 - 8, alpha:1 });
        colocarMonedas();
        sonidoMoneda();
      }

      // Moneda roja: -2 px (mÃ­nimo tamaÃ±o inicial)
      if (colisionCirculoCirculo(x,y,JUGADOR_TAM/2, mrx,mry,MONEDA_RADIO)){
        etam = Math.max(ENEMIGO_TAM_INICIAL, etam - REDUCCION_PX);
        ex = clamp(ex, etam/2, canvas.width - etam/2);
        ey = clamp(ey, etam/2, canvas.height - etam/2);
        colocarMonedas();
        sonidoMonedaRoja();
      }

      // Rayo: boost 8s
      if (rayoActivo && colisionCirculoCirculo(x,y,JUGADOR_TAM/2, rx,ry,RAYO_RADIO)){
        rayoActivo=false;
        boostHasta = Date.now() + BOOST_MS;
        sonidoRayo();
      }

      // Fresa: vuelve al tamaÃ±o inicial (instantÃ¡neo) +10p + texto flotante, o expira
      if (fresaActiva){
        if (colisionCirculoCirculo(x,y,JUGADOR_TAM/2, fx,fy,FRESA_RADIO)){
          fresaActiva=false;
          etam = ENEMIGO_TAM_INICIAL;   // reducciÃ³n instantÃ¡nea
          ex = clamp(ex, etam/2, canvas.width - etam/2);
          ey = clamp(ey, etam/2, canvas.height - etam/2);
          puntosStage += 10;
          textos.push({ msg:"+10p", x:x, y:y - JUGADOR_TAM/2 - 8, alpha:1 });
          sonidoFresa();
        } else if (Date.now() > fresaExpira){
          fresaActiva=false;
        }
      }

      // Actualizar textos flotantes (suben y se desvanecen)
      for (let i = textos.length - 1; i >= 0; i--) {
        const t = textos[i];
        t.y -= 0.6;
        t.alpha -= 0.02;
        if (t.alpha <= 0) textos.splice(i, 1);
      }

      // Cambio de stage cada 300 pts del stage
      if (puntosStage >= 300){
        stage++;
        iniciarStage(stage);
      }
    }

    // ---------- Render ----------
    function dibujar(){
      ctx.clearRect(0,0,canvas.width,canvas.height);

      if (estado === "inicio"){
        ctx.fillStyle="white";
        ctx.font="40px Arial";
        ctx.textAlign="center"; ctx.textBaseline="alphabetic";
        ctx.fillText("SQUARE BOUNCE", canvas.width/2, canvas.height/2 - 40);

        ctx.fillStyle="yellow"; ctx.font="20px Arial";
        ctx.fillText("Usa las flechas para moverte", canvas.width/2, canvas.height/2 + 10);
        ctx.fillText("Esquiva al enemigo", canvas.width/2, canvas.height/2 + 40);

        if (Math.floor(Date.now()/500)%2===0){
          ctx.fillStyle="red";
          ctx.fillText("Presiona ESPACIO para comenzar", canvas.width/2, canvas.height/2 + 100);
        }
        return;
      }

      if (estado === "jugando"){
        // Jugador
        ctx.fillStyle=color;
        ctx.fillRect(x - JUGADOR_TAM/2, y - JUGADOR_TAM/2, JUGADOR_TAM, JUGADOR_TAM);

        // Enemigo
        ctx.fillStyle="white";
        ctx.fillRect(ex - etam/2, ey - etam/2, etam, etam);

        // Moneda amarilla
        ctx.fillStyle="gold";
        ctx.beginPath(); ctx.arc(mx,my,MONEDA_RADIO,0,Math.PI*2); ctx.fill();

        // Moneda roja
        ctx.fillStyle="red";
        ctx.beginPath(); ctx.arc(mrx,mry,MONEDA_RADIO,0,Math.PI*2); ctx.fill();

        // Rayo
        if (rayoActivo){
          ctx.font="26px Arial"; ctx.fillStyle="cyan";
          ctx.textAlign="center"; ctx.textBaseline="middle";
          ctx.fillText("âš¡", rx, ry);
          ctx.textAlign="left"; ctx.textBaseline="alphabetic";
        }

        // Fresa (parpadea Ãºltimos 3s)
        if (fresaActiva){
          const restante = fresaExpira - Date.now();
          const blink = (restante <= 3000) && (Math.floor(Date.now()/300)%2===0);
          if (!blink){
            ctx.font="28px Arial"; ctx.fillStyle="pink";
            ctx.textAlign="center"; ctx.textBaseline="middle";
            ctx.fillText("ðŸ“", fx, fy);
            ctx.textAlign="left"; ctx.textBaseline="alphabetic";
          }
        }

        // HUD
        ctx.fillStyle="white"; ctx.font="20px Arial"; ctx.textAlign="left";
        ctx.fillText("Puntos: " + puntosStage, 10, 25);
        ctx.fillText("Stage: " + stage, 10, 50);

        // Boost
        const ahora=Date.now();
        if (ahora < boostHasta){
          const restante = Math.ceil((boostHasta - ahora)/1000);
          ctx.fillStyle="yellow";
          ctx.fillText("âš¡ Velocidad (" + restante + "s)", 10, 75);
        }

        // Cartel STAGE
        if (mostrarStageCartel){
          ctx.fillStyle="white";
          ctx.font="48px Arial";
          ctx.textAlign="center"; ctx.textBaseline="middle";
          ctx.fillText("STAGE " + stage, canvas.width/2, canvas.height/2);
          if (Date.now() > stageCartelHasta) mostrarStageCartel=false;
        }

        // Textos flotantes
        textos.forEach(t => {
          ctx.save();
          ctx.globalAlpha = Math.max(0, t.alpha);
          ctx.fillStyle = "lime";
          ctx.font = "18px Arial";
          ctx.textAlign = "center";
          ctx.textBaseline = "bottom";
          ctx.fillText(t.msg, t.x, t.y);
          ctx.restore();
        });
        return;
      }

      // GAME OVER
      
      if (estado === "gameover"){
        if (Math.floor(Date.now()/500)%2===0){
          ctx.fillStyle="red"; ctx.font="40px Arial";
          ctx.textAlign="center";
          ctx.fillText("GAME OVER", canvas.width/2, canvas.height/2);
        }
        ctx.fillStyle="yellow"; ctx.font="25px Arial";
        ctx.fillText("Puntos: " + puntosStage, canvas.width/2, canvas.height/2 + 40);
  ctx.fillStyle = "cyan";
  ctx.font = "22px Arial";
  ctx.fillText("Stage alcanzado: " + stage, canvas.width/2, canvas.height/2 + 70);

        if (Math.floor(Date.now()/500)%2===0){
          ctx.fillStyle="white"; ctx.font="20px Arial";
          ctx.fillText("Presiona R para reiniciar", canvas.width/2, canvas.height/2 + 100);
        }
      }
    }
    
    function loop(){ actualizar(); dibujar(); requestAnimationFrame(loop); }
    loop();
    
  </script>
</body>
</html>
